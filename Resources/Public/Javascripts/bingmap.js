define(["bingmap","async!https://www.bing.com/api/maps/mapcontrol?branch=experimental"],function(){"use strict";var t={location:window.location,BingMap:{hiddenclassname:"staddressmap__hiddenlistitem",distancewrapper:".staddressmap__distance",distanceWrapperShowClassname:"staddressmap__distance--show",radiuscolor:"#FF0000",radiusopacity:.35,radiusstrokeweight:0,map:null,marker:null,markers:null,infowindow:null,infowindowTemplate:document.querySelectorAll(".staddressmap__bingmapinfobox")[0].outerHTML,items:document.querySelectorAll("[data-mapmarkeritem]"),markercontent:document.querySelectorAll("[data-mapmarkercontent]"),element:document.querySelectorAll(".staddressmap__map")[0],searchfrompoint:document.querySelectorAll(".staddressmap__searchfrompoint")[0],searchradius:document.querySelectorAll(".staddressmap__searchradius")[0],searchsubmit:document.querySelectorAll(".staddressmap__searchsubmit")[0],searchreset:document.querySelectorAll(".staddressmap__searchreset")[0],mapObject:document.querySelectorAll(".staddressmap")[0],autoZoom:"data-staddressmap-autozoom",clusterMarkers:[],locationArray:[],clusteringDataAttribute:"data-staddressmap-clustering",clusterGridSize:100,init:function(){if(t.BingMap.map=new Microsoft.Maps.Map(t.BingMap.element,{credentials:"AoaPK47y-Kxe6t_cmrtFWDQzCjOGaJMofONHzpy3WCkf9RXaQuATQSv99rYjwxu0"}),t.BingMap.initInfowindow(),t.BingMap.createMarkers(),"1"===t.BingMap.mapObject.getAttribute(t.BingMap.clusteringDataAttribute)?t.BingMap.clusterTheMarkers():t.BingMap.createMarker(),"1"===t.BingMap.mapObject.getAttribute(t.BingMap.autoZoom)){var e=Microsoft.Maps.LocationRect.fromLocations(t.BingMap.locationArray);t.BingMap.map.setView({bounds:e,padding:80})}else t.BingMap.map.setView({zoom:17,center:t.BingMap.locationArray[0]})},createMarkers:function(){t.BingMap.markers=new Microsoft.Maps.EntityCollection,Array.prototype.forEach.call(t.BingMap.items,function(e,a){var i=e.getAttribute("data-staddressmap-latitude"),n=e.getAttribute("data-staddressmap-longitude"),r=e.getAttribute("data-staddressmap-markertitle"),o=t.BingMap.markercontent[a],s=new Microsoft.Maps.Location(i,n),c=new Microsoft.Maps.Pushpin(s);c.metadata={markerid:a,title:r,description:o.innerHTML},Microsoft.Maps.Events.addHandler(c,"click",t.BingMap.openInfoWindow),t.BingMap.markers.push(c),t.BingMap.clusterMarkers.push(c),t.BingMap.locationArray.push(s),a++})},createMarker:function(){t.BingMap.map.entities.push(t.BingMap.markers)},initInfowindow:function(){t.BingMap.infowindow=new Microsoft.Maps.Infobox(t.BingMap.map.getCenter(),{visible:!1,offset:new Microsoft.Maps.Point(-125,16)}),t.BingMap.infowindow.setMap(t.BingMap.map)},createRadius:function(){},openInfoWindow:function(e){t.BingMap.map.setView({center:e.location}),e.target.metadata&&(t.BingMap.infowindow.setOptions({height:300,width:400,zIndex:1,showPointer:!1,htmlContent:t.BingMap.infowindowTemplate.replace("###title###",e.target.metadata.title).replace("###description###",e.target.metadata.description),visible:!0}),t.BingMap.infowindow.setLocation(e.target.getLocation()))},clusterTheMarkers:function(){Microsoft.Maps.loadModule("Microsoft.Maps.Clustering",function(){var e=new Microsoft.Maps.ClusterLayer(t.BingMap.clusterMarkers,{clusteredPinCallback:t.BingMap.createCustomClusteredPin,gridSize:t.BingMap.clusterGridSize});t.BingMap.map.layers.insert(e)})},createCustomClusteredPin:function(e){var a=e.containedPushpins.length,i=Math.log(a)/Math.log(10)*5+12,n="rgba(255, 40, 40, 0.5)";a<10?n="rgba(183, 36, 42, 0.5)":a<100&&(n="rgba(0, 178, 51, 0.5)");var r=['<svg xmlns="http://www.w3.org/2000/svg" width="',2*i,'" height="',2*i,'">','<circle cx="',i,'" cy="',i,'" r="',i,'" fill="',n,'"/>','<circle cx="',i,'" cy="',i,'" r="',i-4,'" fill="',n,'"/>',"</svg>"];e.setOptions({icon:r.join(""),anchor:new Microsoft.Maps.Point(i,i),textOffset:new Microsoft.Maps.Point(0,i-8)}),Microsoft.Maps.Events.addHandler(e,"click",t.BingMap.zoomToClickedCluster)},zoomToClickedCluster:function(e){if(e.target.containedPushpins){for(var a=[],i=0,n=e.target.containedPushpins.length;i<n;i++)a.push(e.target.containedPushpins[i].getLocation());var r=Microsoft.Maps.LocationRect.fromLocations(a);t.BingMap.map.setView({bounds:r,padding:100})}}}};t.BingMap.init()});